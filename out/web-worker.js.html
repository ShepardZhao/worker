<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: web-worker.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: web-worker.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @name $Worker
 *
 * @param {Function} method - the web worker code to be run
 * @param {Function} [fb] - the fallback method to use if the web worker fails
 * @param {Boolean} [debug] - manually set the workers to fallback
 *
 * @description
 * spin up an embedded web worker.
 *
 * @constructor
 */
function $Worker(method, fb, debug) {
  var worker = this;

  var errors = {
    '0001': 'web workers are not supported in your current browser and no fallback has been given'
  };

  var blobArray = ['self.onmessage = ', method, ';']; // array to be used for blob

  worker.hasWorkers = debug ? false : !!window.Worker; // does the browser have workers
  worker.blob = null; // blob container
  worker.shell = null; // shell container

  worker.fb = fb;

  if(worker.hasWorkers) {
    worker.blob = new Blob(blobArray, { type: "text/javascript" });

    worker.shell = new Worker(window.URL.createObjectURL(worker.blob));
  }

  worker.errorHandler = errorHandler;
  worker.getBlobArray = getBlobArray;
  worker.updateBlobArray = updateBlobArray;
  worker.removeFromBlobArray = removeFromBlobArray;

  /**
   * @name errorHandler
   *
   * @memberof $Worker
   *
   * @param {Function} code - the web worker code to be run
   *
   * @description
   * spin up an embedded web worker.
   */
  function errorHandler(code) {
    return {
      code: code,
      message: errors[code]
    };
  }

  /**
   * @name getBlobArray
   *
   * @memberof $Worker
   *
   * @return {Array}
   */
  function getBlobArray() {
    return blobArray;
  }

  /**
   * @name updateBlobArray
   *
   * @memberof $Worker
   *
   * @param {*} val - the item to add to the blobd
   */
  function updateBlobArray(val) {
    blobArray.unshift(val);
  }

  /**
   * @name updateBlobArray
   *
   * @memberof $Worker
   *
   * @param {Number} idx - index to start at
   * @param {Number} length - the number of items to remove
   */
  function removeFromBlobArray(idx, length) {
    blobArray.splice(idx, length);
  }
}

/**
 * @name postMessage
 *
 * @memberof $Worker
 *
 * @description
 * run the created web worker. either post the message to the thread OR return the result of of fallback to the onmessage method
 *
 * @param {*} [data] - the data to be passed to the worker
 */
$Worker.prototype.postMessage = function postMessage(data) {
  var worker = this;

  if(worker.hasWorkers) {
    worker.shell.postMessage(data);

    worker.shell.onmessage = function(res) {
      worker.onmessage(res.data);
    };
  }
  else {
    if(typeof worker.fb === 'function') {
      worker.onmessage(worker.fb({data: data}));
    }
    else {
      worker.onmessage(worker.errorHandler('0001'));
    }
  }
};

/**
 * @name onmessage
 *
 * @memberof $Worker
 *
 * @description
 * override this method to when listening for the worker to complete
 */
$Worker.prototype.onmessage = function onmessage() { };

/**
 * @name terminate
 *
 * @memberof $Worker
 *
 * @description
 * terminate the created web worker
 */
$Worker.prototype.terminate = function terminate() {
  var worker = this;

  if(worker.hasWorkers) {
    worker.shell.terminate();
  }
};


/**
 * @name loadScripts
 *
 * @memberof $Worker
 *
 * @description
 * load named functions into the web worker to be used by the web worker
 */
$Worker.prototype.loadScripts = function loadScripts() {
  var worker = this, current, currentMethod, key;

  for(var i = 0, len = arguments.length; i &lt; len; i++) {
    current = arguments[i];

    key = Object.keys(current)[0];

    currentMethod = current[key];

    worker.updateBlobArray(';');
    worker.updateBlobArray(currentMethod);
    worker.updateBlobArray('var ' + key + ' = ');
  }

  if(worker.hasWorkers) {
    worker.blob = new Blob(worker.getBlobArray(), { type: "text/javascript"});

    worker.shell = new Worker(window.URL.createObjectURL(worker.blob));
  }
};

/**
 * @name removeScripts
 *
 * @memberof $Worker
 *
 * @description
 * remove a previously loaded function from the worker
 */
$Worker.prototype.removeScripts = function removeScripts() {
  var worker = this, array = worker.getBlobArray(), index;

  for(var i = 0, len = arguments.length; i &lt; len; i++) {
    index = array.indexOf('var ' + arguments[i] + ' = ');

    worker.removeFromBlobArray(index, 3);
  }

  if(worker.hasWorkers) {
    worker.blob = new Blob(worker.getBlobArray(), { type: "text/javascript"});

    worker.shell = new Worker(window.URL.createObjectURL(worker.blob));
  }
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="$Worker.html">$Worker</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0</a> on Fri May 15 2015 09:21:21 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
